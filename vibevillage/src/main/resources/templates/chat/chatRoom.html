<!DOCTYPE html>
<html lang="en">
<head>
    <div th:replace="~{common/head :: head}"></div>
    <link rel="stylesheet" th:href="@{/css/chat/chat.css}">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.4.0/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .message {
            display: block;
            padding: 10px;
            margin: 5px;
            border-radius: 10px;
            max-width: 60%;
        }

        .sent {
            background-color: #d1f7c4; /* 보낸 메시지의 배경색 */
            text-align: right;
            margin-left: auto;
        }

        .received {
            background-color: #f1f1f1; /* 받은 메시지의 배경색 */
            text-align: left;
            margin-right: auto;
        }
    </style>

</head>
<body>
<div class="page-loader">
    <div class="loader">로딩 중...</div>
</div>
<div th:replace="~{common/nav :: nav}"></div>


<section class="module-medium">
    <div class="container">
        <div class="unique-chat-container">
            <div id="messageArea">
                <!-- 채팅 메시지가 표시될 영역 -->
                <li th:each="chat:${chatMessage}">
                    <div th:text="${chat.message}"></div>
                </li>

            </div>
                <input autocomplete="off" autofocus class="unique-chat-window-message" id="message" name="chat-window-message" type="text" />
                <button onclick="sendMessage()">Send</button>
        </div>
    </div>
</section>
<div class="scroll-up"><a href="#totop"><i class="fa fa-angle-double-up"></i></a></div>
</main>
<div th:replace="~{common/footer :: footer}"></div>
<div th:replace="~{common/js :: js}"></div>



<script>
    var stompClient = null;
    var roomId = /*[[${roomId}]]*/ '1';

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            stompClient.subscribe('/sub/' + roomId, function (messageOutput) {
                showMessage(JSON.parse(messageOutput.body));
            });
        });
    }

    function sendMessage() {
        var messageContent = document.querySelector('#message').value.trim();
        if (messageContent && stompClient) {
            var chatMessage = {
                senderId: 123,  // 현재 사용자 ID를 사용하세요
                roomId: roomId,  // 현재 채팅방 ID를 사용하세요
                message: messageContent,
                timestamp: new Date().toISOString()  // 현재 시간을 ISO 형식으로
            };
            stompClient.send("/pub/chat.sendMessage/" + roomId, {}, JSON.stringify(chatMessage));
        }

    }


    function showMessage(message) {
        var messageElement = document.createElement('li');
        messageElement.classList.add('message');

        // 현재 사용자의 ID를 가져옵니다 (예: 'currentUserId'라는 변수를 사용)
        var currentUserId = 123; // 이 값을 실제 사용자 ID로 설정하세요

        if (message.senderId === currentUserId) {
            messageElement.classList.add('sent');
        } else {
            messageElement.classList.add('received');
        }

        messageElement.textContent = message.senderId + ": " + message.message;
        document.querySelector('#messageArea').appendChild(messageElement);
    }



    connect();
</script>
<div th:replace="~{common/footer :: footer}"></div>
<div th:replace="~{common/js :: js}"></div>
</body>
</html>